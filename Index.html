<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    /* --- MODERN CSS STYLING --- */
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #1f2937;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    .container {
      background: var(--card);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 450px;
      text-align: center;
    }

    h2 { margin-bottom: 1.5rem; color: var(--text); }

    .input-group { margin-bottom: 1rem; text-align: left; }
    
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
    
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-sizing: border-box; /* Fix padding issue */
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus { border-color: var(--primary); }

    /* Drag & Drop Zone */
    .drop-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
      position: relative;
    }

    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--primary);
      background: #eef2ff;
    }

    .drop-zone p { margin: 0; color: #6b7280; pointer-events: none; }
    .drop-zone input { 
      position: absolute; width: 100%; height: 100%; top:0; left:0; opacity: 0; cursor: pointer; 
    }

    /* File List */
    #fileList {
      margin-top: 1rem;
      text-align: left;
      font-size: 0.85rem;
    }
    .file-item {
      background: #f3f4f6;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-remove { color: red; cursor: pointer; font-weight: bold; }

    /* Button */
    .btn-upload {
      background-color: var(--primary);
      color: white;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1.5rem;
      transition: background 0.2s;
    }

    .btn-upload:hover { background-color: var(--primary-hover); }
    .btn-upload:disabled { background-color: #9ca3af; cursor: not-allowed; }

    /* Loading Overlay */
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
    }
    
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid #e5e7eb;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div class="container">
    <h2>ðŸš€ Smart Uploader</h2>
    
    <div class="input-group">
      <label>Student ID</label>
      <input type="text" id="studentId" placeholder="e.g. 24">
    </div>

    <div class="input-group">
      <label>Subject</label>
      <input type="text" id="subject" placeholder="e.g. chemistry">
    </div>

    <div class="drop-zone" id="dropZone">
      <p>ðŸ“‚ Drag & Drop files here<br><small>or click to browse</small></p>
      <input type="file" id="fileInput" multiple>
    </div>

    <div id="fileList"></div>

    <button class="btn-upload" id="uploadBtn" onclick="startUpload()">Upload Files</button>
  </div>

  <div class="loader-overlay" id="loader">
    <div class="spinner"></div>
    <h3 style="color:var(--primary)">Processing...</h3>
    <p>Detecting ghosts & translating aliens ðŸ‘½</p>
  </div>

  <script>
    // --- JAVASCRIPT LOGIC ---
    
    // 1. Handle File Selection Visuals
    const fileInput = document.getElementById('fileInput');
    const fileListDisplay = document.getElementById('fileList');
    const dropZone = document.getElementById('dropZone');
    let selectedFiles = [];

    // Drag effects
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false)
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', handleDrop);

    function handleDrop(e) {
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      handleFiles(files);
    }

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
      selectedFiles = [...files]; // Store files
      updateFileList();
    }

    function updateFileList() {
      fileListDisplay.innerHTML = "";
      selectedFiles.forEach((file, index) => {
        let div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `<span>${file.name}</span> <span class="file-remove" onclick="removeFile(${index})">Ã—</span>`;
        fileListDisplay.appendChild(div);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
    }

    // 2. The Upload Logic
    function startUpload() {
      const id = document.getElementById('studentId').value.trim();
      const subject = document.getElementById('subject').value.trim();

      if (!id || !subject || selectedFiles.length === 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Missing Info',
          text: 'Please fill in ID, Subject, and select at least one file.'
        });
        return;
      }

      // Show Loading Screen
      document.getElementById('loader').style.display = 'flex';
      document.getElementById('uploadBtn').disabled = true;

      // Read files as Base64
      const promises = selectedFiles.map(file => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const data = e.target.result.split(',')[1]; // Remove "data:application..." header
            resolve({ name: file.name, mimeType: file.type, data: data });
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      });

      Promise.all(promises).then(filesData => {
        const payload = {
          id: id,
          subject: subject,
          files: filesData
        };

        // Send to Google Script
        // We use a trick to send JSON because GAS parameters can be tricky with large objects
        const jsonPayload = JSON.stringify(payload);

        // We need to simulate a POST request for the doPost function to catch it correctly
        // Or we can just call a specialized function. 
        // NOTE: Since you are using doPost(e), we can't call it directly from client-side JS like this easily.
        // BUT, since we have the script, we should use google.script.run
        
        // *However*, your doPost is built for external Webhooks. 
        // To make this work with the internal UI, we need to bypass doPost and call a helper.
        // Let's assume you want to keep using the Web App URL for consistency.
        
        // Let's actually fetch the Web App URL!
        const webAppUrl = "YOUR_CURRENT_WEB_APP_URL_HERE"; // <--- PASTE YOUR DEPLOYMENT URL HERE
        
        if(webAppUrl === "https://script.google.com/macros/s/AKfycbx0_Hmdm2gucB87juLA_Rmzt1x8iL-ewnu3MsSf0SnEZQxqmN0e0I_1aktk_vw4j9kN/exec") {
           // Fallback if user forgot to paste URL: Try to use google.script.run logic
           // But since your backend is strictly doPost(e), we have to use fetch.
           Swal.fire('Config Error', 'Please edit the HTML code and paste your Web App URL in the script section!', 'error');
           document.getElementById('loader').style.display = 'none';
           document.getElementById('uploadBtn').disabled = false;
           return;
        }

        fetch(webAppUrl, {
          method: 'POST',
          body: jsonPayload
        })
        .then(response => response.json())
        .then(result => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('uploadBtn').disabled = false;

          if (result.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: 'Upload Complete!',
              text: 'Files converted and uploaded successfully.',
              timer: 3000,
              showConfirmButton: false
            });
            // Clear form
            selectedFiles = [];
            updateFileList();
            document.getElementById('fileInput').value = "";
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Server Error',
              text: 'Check logs: ' + JSON.stringify(result.logs)
            });
          }
        })
        .catch(err => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('uploadBtn').disabled = false;
          Swal.fire('Network Error', err.toString(), 'error');
        });

      });
    }
  </script>
</body>
</html>
