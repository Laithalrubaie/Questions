<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #f4f6fb; --card: #ffffff; --primary: #2f3a8f; --secondary: #e9ecff; --text: #1f2937; --muted: #6b7280; --border: #e5e7eb; --radius: 14px; --success: #10b981; }
    body { margin: 0; font-family: "Cairo", sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: auto; padding: 32px 20px 60px; }
    header { text-align: center; margin-bottom: 30px; cursor: pointer; user-select: none; }
    .tabs-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 30px; background: #fff; padding: 15px; border-radius: var(--radius); }
    .tab-btn { background: transparent; border: 2px solid var(--secondary); color: var(--muted); padding: 8px 16px; border-radius: 50px; font-family: "Cairo"; font-weight: 700; cursor: pointer; }
    .tab-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; }
    .subject-content { display: none; }
    .active-content { display: block; }
    .subject-card { background: var(--card); border-radius: var(--radius); margin-bottom: 20px; border: 1px solid var(--border); overflow: hidden; }
    .card-header { padding: 15px 20px; font-weight: 700; color: var(--primary); background: linear-gradient(135deg, var(--secondary), #ffffff); border-bottom: 1px solid var(--border); }
    details { border-bottom: 1px solid var(--border); }
    summary { cursor: pointer; padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th, td { padding: 14px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    th.chapter-col { width: 25%; color: var(--primary); background: #fcfcfc; }
    .upload-btn { background: var(--secondary); color: var(--primary); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: "Cairo"; font-weight: bold; }
    .upload-btn:hover { background: var(--primary); color: white; }
    .table-wrapper { overflow-x: auto; }
    
    /* MODAL STYLES */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
    .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; color: var(--primary); }
    .file-drop-area { border: 2px dashed var(--secondary); padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; }
    .file-drop-area:hover { border-color: var(--primary); background: #fafbff; }
    .file-input { display: none; }
    .file-list { margin-bottom: 20px; max-height: 150px; overflow-y: auto; font-size: 0.9rem; }
    .file-item { display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; margin-bottom: 5px; border-radius: 6px; }
    .modal-actions { display: flex; gap: 10px; }
    .btn-submit { flex: 2; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-family: "Cairo"; font-weight: bold; cursor: pointer; }
    .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
    .btn-cancel { flex: 1; background: transparent; border: 1px solid #ddd; color: #666; border-radius: 10px; cursor: pointer; font-family: "Cairo"; }
    
    .spinner { width: 20px; height: 20px; border: 3px solid #ffffff33; border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* SECRET DEBUG TERMINAL */
    #debug-console {
      display: none; 
      position: fixed; bottom: 0; left: 0; width: 100%; height: 200px;
      background: #0d1117; color: #00ff41; font-family: 'Courier New', monospace;
      padding: 10px; overflow-y: auto; z-index: 9999;
      border-top: 3px solid #00ff41; direction: ltr; text-align: left; font-size: 12px;
    }
    .log-line { border-bottom: 1px solid #333; padding: 2px 0; }
    .log-line.error { color: #ff4d4d; }
    .log-line.success { color: #00ff41; }
  </style>
</head>
<body>

<div class="container">
  <header id="main-header">
    <h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h1>
    <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</p>
  </header>

  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('chemistry')">Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</button>
    <button class="tab-btn" onclick="switchTab('biology')">Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</button>
    <button class="tab-btn" onclick="switchTab('math')">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="switchTab('arabic')">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="tab-btn" onclick="switchTab('physics')">Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</button>
    <button class="tab-btn" onclick="switchTab('english')">English</button>
  </div>

  <div id="content-area">
      <div style="text-align:center; padding: 20px;">
          <div class="spinner" style="border-color: #2f3a8f; border-top-color: transparent;"></div>
          <p style="margin-top:10px; color:#666;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
      </div>
  </div>
</div>

<div class="modal-overlay" id="uploadModal">
  <div class="modal-card">
    <div class="modal-title">Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</div>
    <div id="modalSubtitle" style="margin-bottom:15px; font-size:0.9rem; color:#666;"></div>
    
    <div class="file-drop-area" onclick="document.getElementById('fileInput').click()">
      <span style="font-size:24px">ğŸ“‚</span><br>
      Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª<br>
      <span style="font-size:12px; color:#999">PDF, Images, Word</span>
    </div>
    <input type="file" id="fileInput" class="file-input" multiple onchange="handleFileSelect(this)">
    
    <div class="file-list" id="fileList"></div>
    
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-submit" id="submitBtn" onclick="submitUpload()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¹</button>
    </div>
  </div>
</div>

<div id="debug-console">
  <div>> SYSTEM READY. TRIPLE CLICK TITLE TO TOGGLE.</div>
</div>

<script>
  // =========================================================================
  // PASTE YOUR NEWEST DEPLOYMENT URL HERE
  // =========================================================================
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_Hmdm2gucB87juLA_Rmzt1x8iL-ewnu3MsSf0SnEZQxqmN0e0I_1aktk_vw4j9kN/exec";
  // =========================================================================

  let currentUpload = { id: null, subject: null, files: [] };

  // Initialize
  document.addEventListener('DOMContentLoaded', fetchData);

  // --- TRIPLE CLICK SECRET ---
  let clickCount = 0;
  const titleHeader = document.getElementById('main-header');
  const debugConsole = document.getElementById('debug-console');

  titleHeader.addEventListener('click', () => {
    clickCount++;
    if (clickCount === 3) {
      debugConsole.style.display = (debugConsole.style.display === 'block') ? 'none' : 'block';
      logToConsole("DEBUG MODE TOGGLED");
      clickCount = 0;
    }
    setTimeout(() => clickCount = 0, 1000);
  });

  function logToConsole(msg, type = 'normal') {
    const line = document.createElement('div');
    line.className = `log-line ${type}`;
    line.innerText = `> ${msg}`;
    debugConsole.appendChild(line);
    debugConsole.scrollTop = debugConsole.scrollHeight; 
  }

  // --- MAIN LOGIC ---

  async function fetchData() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      renderAll(data);
    } catch(e) {
      console.error(e);
      document.getElementById('content-area').innerHTML = `
        <div style="text-align:center; color:red; padding:30px;">
           Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.<br>
           <button onclick="location.reload()" style="margin-top:10px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </div>`;
    }
  }

  function renderAll(data) {
    const container = document.getElementById('content-area');
    container.innerHTML = '';
    const subjectMap = { 
      'chemistry': 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', 'biology': 'Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', 'math': 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 
      'arabic': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'physics': 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', 'english': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' 
    };
    
    Object.keys(subjectMap).forEach((subj, index) => {
      const subjectName = subjectMap[subj];
      const isActive = (index === 0) ? 'active-content' : '';
      const cardDiv = document.createElement('div');
      cardDiv.id = subj;
      cardDiv.className = `subject-content ${isActive}`;
      
      let cardHTML = `<div class="subject-card"><div class="card-header">${subjectName}</div>`;
      const subjectData = data[subj];

      if (!subjectData || Object.keys(subjectData).length === 0) {
        cardHTML += `<div style="padding:40px; text-align:center; color:#888;"><span style="font-size:30px;">ğŸ‰</span><br>ØªÙ… Ø±ÙØ¹ ÙƒÙ„ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ${subjectName}!</div>`;
      } else {
        for (const [grade, lectures] of Object.entries(subjectData)) {
          let rowsHTML = '';
          lectures.forEach(l => {
            rowsHTML += `
              <tr id="row-${l.id}">
                <td class="chapter-col">${l.chapter}</td>
                <td>${l.lecture}</td>
                <td style="text-align:center"><button class="upload-btn" onclick="openUploadModal('${l.id}', '${subj}', '${l.lecture}')">Ø±ÙØ¹</button></td>
              </tr>`;
          });
          cardHTML += `
            <details>
              <summary>${grade}</summary>
              <div class="table-wrapper">
                <table><thead><tr><th class="chapter-col">Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</th><th style="width:100px">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${rowsHTML}</tbody></table>
              </div>
            </details>`;
        }
      }
      cardHTML += `</div></div>`;
      cardDiv.innerHTML = cardHTML;
      container.appendChild(cardDiv);
    });
  }

  // --- UPLOAD HANDLERS ---

  window.openUploadModal = function(id, subject, title) {
    currentUpload = { id: id, subject: subject, files: [] };
    document.getElementById('modalSubtitle').innerText = title;
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('fileInput').value = ''; 
    document.getElementById('uploadModal').classList.add('open');
  };

  window.closeModal = function() {
    document.getElementById('uploadModal').classList.remove('open');
  };

  window.handleFileSelect = function(input) {
    const list = document.getElementById('fileList');
    list.innerHTML = ''; 
    currentUpload.files = [];
    Array.from(input.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        currentUpload.files.push({
          name: file.name,
          mimeType: file.type,
          data: e.target.result.split(',')[1]
        });
      };
      reader.readAsDataURL(file);
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerText = `ğŸ“„ ${file.name}`;
      list.appendChild(item);
    });
  };

  window.submitUpload = function() {
    const btn = document.getElementById('submitBtn');
    if(currentUpload.files.length === 0) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

    btn.innerHTML = '<div class="spinner"></div>';
    btn.disabled = true;
    logToConsole("Starting Upload...", "normal");

    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(currentUpload)
    })
    .then(response => response.json())
    .then(data => {
       // --- PRINT SERVER LOGS ---
       if (data.logs && data.logs.length > 0) {
         data.logs.forEach(log => logToConsole(log));
       }

       if (data.status === "error") {
         alert("Ø®Ø·Ø£: " + data.message);
         logToConsole("ERROR: " + data.message, "error");
         btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¹';
         btn.disabled = false;
         return;
       }

       logToConsole("Upload Success!", "success");
       closeModal();
       btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¹';
       btn.disabled = false;
       
       const row = document.getElementById(`row-${currentUpload.id}`);
       if(row) {
         row.style.transition = 'all 0.5s';
         row.style.opacity = '0';
         setTimeout(() => {
           const tbody = row.parentElement;
           row.remove();
           if (tbody.children.length === 0) {
              const details = tbody.closest('.table-wrapper').parentElement; 
              const card = details.parentElement;  
              details.remove();
              if (card.querySelectorAll('details').length === 0) {
                  card.innerHTML = `<div style="padding:40px; text-align:center; color:#888;">ğŸ‰<br>Ø¹Ø§Ø´ØŒ ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙƒÙ„!</div>`;
              }
           }
         }, 500);
       }
    })
    .catch(err => {
      console.error(err);
      logToConsole("FETCH ERROR: " + err.toString(), "error");
      alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.toString());
      btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¹';
      btn.disabled = false;
    });
  };

  window.switchTab = function(id) {
    document.querySelectorAll('.subject-content').forEach(c => c.classList.remove('active-content'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active-content');
    if(event && event.target) event.target.classList.add('active');
  };
</script>
</body>
</html>
