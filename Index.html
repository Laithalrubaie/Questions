<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: #f0f2f5;
Â  Â  Â  --surface: #ffffff;
Â  Â  Â  --primary: #4361ee;
Â  Â  Â  --primary-dark: #3a56d4;
Â  Â  Â  --secondary: #eef2ff;
Â  Â  Â  --text-main: #1f2937;
Â  Â  Â  --text-muted: #6b7280;
Â  Â  Â  --border: #e5e7eb;
Â  Â  Â  --radius: 16px;
Â  Â  Â  --success: #10b981;
Â  Â  Â  --danger: #ef4444;
Â  Â  Â  --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
Â  Â  }

Â  Â  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
Â  Â Â 
Â  Â  body {Â 
Â  Â  Â  margin: 0;Â 
Â  Â  Â  font-family: "Cairo", sans-serif;Â 
Â  Â  Â  background: var(--bg);Â 
Â  Â  Â  color: var(--text-main);Â 
Â  Â  Â  overflow-x: hidden;
Â  Â  }

Â  Â  .container { max-width: 1000px; margin: auto; padding: 40px 20px 80px; }

Â  Â  /* HEADER */
    header { text-align: center; margin-bottom: 40px; cursor: pointer; user-select: none; }
Â  Â  header h1 { margin: 0; font-size: 2rem; color: var(--primary); font-weight: 800; letter-spacing: -0.5px; }
Â  Â  header p { margin: 8px 0 0; color: var(--text-muted); font-size: 1rem; }

    .theme-toggle {
      margin-top: 12px;
      padding: 6px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      font-family: "Cairo";
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
    }
    .theme-toggle:hover {
      background: var(--secondary);
      color: var(--primary);
      border-color: var(--primary);
      transform: translateY(-1px);
    }

Â  Â  /* TABS */
Â  Â  .tabs-wrapper {
Â  Â  Â  background: var(--surface);
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 50px;
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  position: sticky;
Â  Â  Â  top: 20px;
Â  Â  Â  z-index: 90;
Â  Â  }
Â  Â Â 
Â  Â  .tab-btn {
Â  Â  Â  background: transparent;
Â  Â  Â  border: none;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  border-radius: 40px;
Â  Â  Â  font-family: "Cairo";
Â  Â  Â  font-weight: 700;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  font-size: 0.95rem;
Â  Â  }
Â  Â Â 
Â  Â  .tab-btn:hover { background: var(--secondary); color: var(--primary); }
Â  Â  .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); }

Â  Â  /* CONTENT CARDS */
Â  Â  .subject-content { display: none; animation: fadeIn 0.4s ease forwards; }
Â  Â  .active-content { display: block; }
Â  Â Â 
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

Â  Â  .subject-card {Â 
Â  Â  Â  background: var(--surface);Â 
Â  Â  Â  border-radius: var(--radius);Â 
Â  Â  Â  box-shadow: var(--shadow);Â 
Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  margin-bottom: 25px;Â 
Â  Â  }

Â  Â  .card-header {
Â  Â  Â  padding: 20px 24px;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: var(--primary);
Â  Â  Â  border-bottom: 1px solid var(--border);
Â  Â  Â  background: linear-gradient(to left, #fff, var(--secondary));
Â  Â  }

    /* SEARCH BAR */
    .search-bar {
      padding: 10px 20px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .search-input {
      width: 100%;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-family: "Cairo";
      font-size: 0.9rem;
      background: transparent;
      color: var(--text-main);
    }
    .search-input::placeholder {
      color: var(--text-muted);
    }
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      outline: none;
    }

Â  Â  /* ACCORDION (DETAILS/SUMMARY) */
Â  Â  details { border-bottom: 1px solid var(--border); transition: all 0.3s ease; }
    details[open] { background: var(--surface); }
Â  Â  details:last-child { border-bottom: none; }

Â  Â  summary {
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 18px 24px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  list-style: none;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
    summary:hover { background: var(--bg); }
Â  Â  summary::-webkit-details-marker { display: none; }
Â  Â Â 
Â  Â  summary::after {
Â  Â  Â  content: 'â®'; /* Chevron */
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  transform: rotate(90deg);
Â  Â  }
Â  Â  details[open] summary::after { transform: rotate(-90deg); color: var(--primary); }

Â  Â  /* TABLES */
Â  Â  .table-wrapper { overflow-x: auto; padding-bottom: 5px; }
Â  Â Â 
Â  Â  /* Custom Scrollbar */
Â  Â  .table-wrapper::-webkit-scrollbar { height: 6px; }
Â  Â  .table-wrapper::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
Â  Â Â 
Â  Â  table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: right; color: var(--text-muted); font-size: 0.85rem; padding: 12px 24px; background: var(--bg); font-weight: 600; }
Â  Â  td { padding: 16px 24px; border-top: 1px solid var(--border); vertical-align: middle; }
Â  Â  tr:last-child td { border-bottom: none; }
Â  Â Â 
Â  Â  .chapter-badge {
Â  Â  Â  display: inline-block;
Â  Â  Â  background: var(--secondary);
Â  Â  Â  color: var(--primary);
Â  Â  Â  padding: 4px 10px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  font-weight: 700;
Â  Â  }

Â  Â  /* BUTTONS */
Â  Â  .upload-btn {
      background: var(--surface);
Â  Â  Â  border: 2px solid var(--secondary);
Â  Â  Â  color: var(--primary);
Â  Â  Â  padding: 8px 18px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-family: "Cairo";
Â  Â  Â  font-weight: 700;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  transition: 0.2s;
Â  Â  }
Â  Â  .upload-btn:hover { background: var(--primary); border-color: var(--primary); color: white; transform: translateY(-2px); }

Â  Â  /* MODAL */
Â  Â  .modal-overlay {
Â  Â  Â  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
Â  Â  Â  z-index: 1000; justify-content: center; align-items: center;
Â  Â  Â  opacity: 0; transition: opacity 0.3s ease;
Â  Â  }
Â  Â  .modal-overlay.open { display: flex; opacity: 1; }
Â  Â Â 
Â  Â  .modal-card {
      background: var(--surface); padding: 32px; border-radius: 24px; width: 90%; max-width: 480px;
Â  Â  Â  box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  }
Â  Â  .modal-overlay.open .modal-card { transform: scale(1); }

Â  Â  .modal-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 5px; }
Â  Â  .modal-subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; }

Â  Â  .file-drop-area {
      border: 2px dashed #cbd5e1; background: var(--bg);
Â  Â  Â  padding: 40px 20px; text-align: center; border-radius: 16px;
Â  Â  Â  cursor: pointer; transition: 0.3s;
Â  Â  }
Â  Â  .file-drop-area:hover { border-color: var(--primary); background: #f0f4ff; }
Â  Â Â 
Â  Â  .file-list { margin-top: 15px; max-height: 120px; overflow-y: auto; }
Â  Â  .file-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; background: var(--surface); border: 1px solid var(--border);
Â  Â  Â  border-radius: 10px; margin-bottom: 8px; font-size: 0.9rem;
Â  Â  }

    .file-thumb {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .file-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .file-remove-btn {
      border: none;
      background: transparent;
      color: var(--danger);
      font-family: "Cairo";
      font-size: 0.8rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      flex-shrink: 0;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .file-remove-btn:hover {
      background: rgba(239, 68, 68, 0.08);
      transform: translateY(-1px);
    }

Â  Â  .modal-actions { display: flex; gap: 12px; margin-top: 25px; }
Â  Â  .btn-submit { flex: 2; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-family: "Cairo"; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 1rem; }
Â  Â  .btn-submit:hover:not(:disabled) { background: var(--primary-dark); }
Â  Â  .btn-submit:disabled { background: #cbd5e1; cursor: not-allowed; }
Â  Â  .btn-cancel { flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 12px; cursor: pointer; font-family: "Cairo"; font-weight: 600; }
Â  Â  .btn-cancel:hover { background: #f9fafb; }

Â  Â  /* TOAST NOTIFICATION */
Â  Â  #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
Â  Â  .toast {
Â  Â  Â  background: #333; color: white; padding: 12px 24px; border-radius: 50px;
Â  Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-size: 0.9rem; font-weight: 600;
Â  Â  Â  display: flex; align-items: center; gap: 10px; animation: slideUp 0.3s ease forwards;
Â  Â  }
Â  Â  .toast.success { background: var(--success); }
Â  Â  .toast.error { background: var(--danger); }
Â  Â  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

Â  Â  /* SPINNER */
Â  Â  .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: auto; }
Â  Â  .page-loader { width: 40px; height: 40px; border-color: var(--secondary); border-top-color: var(--primary); }
Â  Â  @keyframes spin { to { transform: rotate(360deg); } }

Â  Â  /* DEBUG */
Â  Â  #debug-console { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 200px; background: #111; color: #0f0; font-family: monospace; padding: 10px; overflow-y: auto; z-index: 9999; font-size: 12px; direction: ltr; text-align: left; opacity: 0.95; }
Â  Â  .log-line { border-bottom: 1px solid #333; padding: 2px 0; }
Â  Â  .log-line.error { color: #ff5555; }

    /* DARK MODE */
    body.dark-mode {
      --bg: #020617;
      --surface: #020617;
      --primary: #38bdf8;
      --primary-dark: #0ea5e9;
      --secondary: #0f172a;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --shadow: 0 16px 40px rgba(0, 0, 0, 0.7);
    }

    body.dark-mode .card-header {
      background: linear-gradient(to left, #020617, #0f172a);
    }

    body.dark-mode details[open] {
      background: #020617;
    }

    body.dark-mode summary:hover {
      background: #020617;
    }

    body.dark-mode th {
      background: #020617;
    }

    body.dark-mode .modal-card {
      background: #020617;
    }

    body.dark-mode .file-drop-area {
      background: #020617;
      border-color: #1f2937;
    }

    body.dark-mode .file-item {
      background: #020617;
    }

    body.dark-mode #debug-console {
      background: #020617;
    }
Â  </style>
</head>
<body>

<div class="container">
Â  <header id="main-header">
Â  Â  <h1>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h1>
Â  Â  <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()"></button>
Â  </header>

Â  <div class="tabs-wrapper">
Â  Â  <button class="tab-btn active" onclick="switchTab('chemistry')">Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</button>
Â  Â  <button class="tab-btn" onclick="switchTab('biology')">Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</button>
Â  Â  <button class="tab-btn" onclick="switchTab('math')">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
Â  Â  <button class="tab-btn" onclick="switchTab('arabic')">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
Â  Â  <button class="tab-btn" onclick="switchTab('physics')">Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</button>
Â  Â  <button class="tab-btn" onclick="switchTab('english')">English</button>
Â  </div>

Â  <div id="content-area">
Â  Â  Â  <div style="text-align:center; padding: 80px 20px;">
Â  Â  Â  Â  Â  <div class="spinner page-loader"></div>
Â  Â  Â  Â  Â  <p style="margin-top:15px; color:var(--text-muted); font-weight:600;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
Â  Â  Â  </div>
Â  </div>
</div>

<div class="modal-overlay" id="uploadModal">
Â  <div class="modal-card">
Â  Â  <div class="modal-title">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
Â  Â  <div id="modalSubtitle" class="modal-subtitle"></div>
Â  Â Â 
Â  Â  <div class="file-drop-area" onclick="document.getElementById('fileInput').click()">
Â  Â  Â  <div style="font-size:32px; margin-bottom:10px;">â˜ï¸</div>
Â  Â  Â  <div style="font-weight:700; color:var(--primary)">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª</div>
Â  Â  Â  <div style="font-size:12px; color:#94a3b8; margin-top:5px;">ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØ± Ùˆ PDF</div>
Â  Â  </div>
Â  Â  <input type="file" id="fileInput" hidden multiple onchange="handleFileSelect(this)">
Â  Â Â 
Â  Â  <div class="file-list" id="fileList"></div>
Â  Â Â 
Â  Â  <div class="modal-actions">
Â  Â  Â  <button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
Â  Â  Â  <button class="btn-submit" id="submitBtn" onclick="submitUpload()">Ø±ÙØ¹ Ø§Ù„Ø¢Ù†</button>
Â  Â  </div>
Â  </div>
</div>

<div id="toast-container"></div>

<div id="debug-console">
Â  <div>> SYSTEM READY. TRIPLE CLICK TITLE TO TOGGLE.</div>
</div>

<script>
Â  // =========================================================================
Â  // CONFIGURATION
Â  // =========================================================================
Â  const API_URL = "https://script.google.com/macros/s/AKfycbx0_Hmdm2gucB87juLA_Rmzt1x8iL-ewnu3MsSf0SnEZQxqmN0e0I_1aktk_vw4j9kN/exec";
Â Â 
  let currentUpload = { id: null, subject: null, files: [] };

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/57687730-fad6-406e-985b-ff8325d62eeb', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: 'log_domcontent_' + Date.now(),
        timestamp: Date.now(),
        runId: 'initial',
        hypothesisId: 'H-runtime',
        location: 'index.html:DOMContentLoaded',
        message: 'DOMContentLoaded fired, initializing app',
        data: {}
      })
    }).catch(() => {});
    // #endregion

    initTheme();
    fetchData();
  });

Â  // --- TRIPLE CLICK SECRET ---
Â  let clickCount = 0;
Â  const titleHeader = document.getElementById('main-header');
Â  const debugConsole = document.getElementById('debug-console');

Â  titleHeader.addEventListener('click', () => {
Â  Â  clickCount++;
Â  Â  if (clickCount === 3) {
Â  Â  Â  debugConsole.style.display = (debugConsole.style.display === 'block') ? 'none' : 'block';
Â  Â  Â  logToConsole("DEBUG MODE TOGGLED");
Â  Â  Â  clickCount = 0;
Â  Â  }
Â  Â  setTimeout(() => clickCount = 0, 1000);
Â  });

Â  function logToConsole(msg, type = 'normal') {
Â  Â  const line = document.createElement('div');
Â  Â  line.className = `log-line ${type}`;
Â  Â  line.innerText = `> ${msg}`;
Â  Â  debugConsole.appendChild(line);
Â  Â  debugConsole.scrollTop = debugConsole.scrollHeight;Â 
Â  }

Â  function showToast(msg, type = 'success') {
Â  Â  const container = document.getElementById('toast-container');
Â  Â  const toast = document.createElement('div');
Â  Â  toast.className = `toast ${type}`;
Â  Â  const icon = type === 'success' ? 'âœ…' : 'âš ï¸';
Â  Â  toast.innerHTML = `<span>${icon}</span> ${msg}`;
Â  Â  container.appendChild(toast);
Â  Â  setTimeout(() => {
Â  Â  Â  Â  toast.style.opacity = '0';
Â  Â  Â  Â  toast.style.transform = 'translateY(20px)';
Â  Â  Â  Â  setTimeout(() => toast.remove(), 300);
Â  Â  }, 3000);
Â  }

Â  // --- MAIN LOGIC ---

Â  async function fetchData() {
Â  Â  try {
Â  Â  Â  const res = await fetch(API_URL);
Â  Â  Â  const data = await res.json();
Â  Â  Â  renderAll(data);
Â  Â  } catch(e) {
Â  Â  Â  console.error(e);
Â  Â  Â  document.getElementById('content-area').innerHTML = `
Â  Â  Â  Â  <div style="text-align:center; color:var(--danger); padding:40px;">
Â  Â  Â  Â  Â  Â <div style="font-size:40px; margin-bottom:10px;">ğŸ”Œ</div>
Â  Â  Â  Â  Â  Â <b>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</b><br>
Â  Â  Â  Â  Â  Â <button onclick="location.reload()" class="upload-btn" style="margin-top:15px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
Â  Â  Â  Â  </div>`;
Â  Â  }
Â  }

Â  function renderAll(data) {
Â  Â  const container = document.getElementById('content-area');
Â  Â  container.innerHTML = '';
    const subjectMap = { 
Â  Â  Â  'chemistry': 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', 'biology': 'Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', 'math': 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',Â 
Â  Â  Â  'arabic': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'physics': 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', 'english': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'Â 
Â  Â  };
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/57687730-fad6-406e-985b-ff8325d62eeb', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: 'log_renderall_' + Date.now(),
        timestamp: Date.now(),
        runId: 'initial',
        hypothesisId: 'H-data',
        location: 'index.html:renderAll',
        message: 'renderAll called with subjects',
        data: { subjectKeys: Object.keys(subjectMap), receivedKeys: Object.keys(data || {}) }
      })
    }).catch(() => {});
    // #endregion
Â  Â Â 
Â  Â  Object.keys(subjectMap).forEach((subj, index) => {
Â  Â  Â  const subjectName = subjectMap[subj];
      const isActive = (index === 0) ? 'active-content' : '';
Â  Â  Â  const cardDiv = document.createElement('div');
Â  Â  Â  cardDiv.id = subj;
Â  Â  Â  cardDiv.className = `subject-content ${isActive}`;
Â  Â  Â Â 
      let cardHTML = `
        <div class="subject-card">
          <div class="card-header">${subjectName}</div>
          <div class="search-bar">
            <input
              type="text"
              class="search-input"
              placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ ${subjectName}..."
              oninput="filterLectures('${subj}', this.value)"
            />
          </div>`;
Â  Â  Â  const subjectData = data[subj];

Â  Â  Â  if (!subjectData || Object.keys(subjectData).length === 0) {
Â  Â  Â  Â  cardHTML += `
Â  Â  Â  Â  Â  <div style="padding:60px; text-align:center; color:var(--text-muted);">
Â  Â  Â  Â  Â  Â  <div style="font-size:40px; margin-bottom:10px;">ğŸ‰</div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:600;">Ø±Ø§Ø¦Ø¹! ØªÙ… Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ${subjectName}</div>
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  } else {
Â  Â  Â  Â  for (const [grade, lectures] of Object.entries(subjectData)) {
Â  Â  Â  Â  Â  let rowsHTML = '';
Â  Â  Â  Â  Â  lectures.forEach(l => {
Â  Â  Â  Â  Â  Â  rowsHTML += `
Â  Â  Â  Â  Â  Â  Â  <tr id="row-${l.id}">
Â  Â  Â  Â  Â  Â  Â  Â  <td width="25%"><span class="chapter-badge">${l.chapter}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${l.lecture}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; width:120px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="upload-btn" onclick="openUploadModal('${l.id}', '${subj}', '${l.lecture}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ø±ÙØ¹ ğŸ“¤
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  cardHTML += `
Â  Â  Â  Â  Â  Â  <details open>
Â  Â  Â  Â  Â  Â  Â  <summary>${grade}</summary>
Â  Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</th><th style="text-align:center">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${rowsHTML}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </details>`;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  cardHTML += `</div></div>`;
Â  Â  Â  cardDiv.innerHTML = cardHTML;
Â  Â  Â  container.appendChild(cardDiv);
Â  Â  });
Â  }

Â  // --- UPLOAD HANDLERS ---

Â  window.openUploadModal = function(id, subject, title) {
Â  Â  currentUpload = { id: id, subject: subject, files: [] };
Â  Â  document.getElementById('modalSubtitle').innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù€: ${title}`;
Â  Â  document.getElementById('fileList').innerHTML = '';
    document.getElementById('fileInput').value = ''; 
    document.getElementById('uploadModal').classList.add('open');
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/57687730-fad6-406e-985b-ff8325d62eeb', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: 'log_modal_open_' + Date.now(),
        timestamp: Date.now(),
        runId: 'initial',
        hypothesisId: 'H-modal',
        location: 'index.html:openUploadModal',
        message: 'Upload modal opened',
        data: {
          uploadId: id,
          subject,
          hasOpenClass: document.getElementById('uploadModal').classList.contains('open')
        }
      })
    }).catch(() => {});
    // #endregion
Â  };

Â  window.closeModal = function() {
Â  Â  document.getElementById('uploadModal').classList.remove('open');
Â  };

Â  window.handleFileSelect = function(input) {
Â  Â  const list = document.getElementById('fileList');
    list.innerHTML = '';
    currentUpload.files = [];
    
    Array.from(input.files).forEach(file => {
      const reader = new FileReader();
      const fileId = Date.now().toString() + Math.random().toString(16).slice(2);

      reader.onload = function(e) {
        const dataUrl = e.target.result;
        const base64 = dataUrl.split(',')[1];

        currentUpload.files.push({
          id: fileId,
          name: file.name,
          mimeType: file.type,
          data: base64
        });

        const item = document.createElement('div');
        item.className = 'file-item';
        item.dataset.fileId = fileId;

        const isImage = file.type && file.type.startsWith('image/');
        const preview = isImage
          ? `<img src="${dataUrl}" alt="${file.name}" class="file-thumb">`
          : `<span class="file-icon">ğŸ“„</span>`;

        item.innerHTML = `
          ${preview}
          <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            <b>${file.name}</b>
          </div>
          <button
            type="button"
            class="file-remove-btn"
            onclick="removeSelectedFile('${fileId}', this)"
          >
            Ø­Ø°Ù
          </button>
        `;

        list.appendChild(item);
      };

      reader.readAsDataURL(file);
    });
Â  };

  window.removeSelectedFile = function(fileId, btnEl) {
    currentUpload.files = currentUpload.files.filter(f => f.id !== fileId);
    const item = btnEl.closest('.file-item');
    if (item) {
      item.remove();
    }
  };

Â  window.submitUpload = function() {
Â  Â  const btn = document.getElementById('submitBtn');
    if(currentUpload.files.length === 0) { 
Â  Â  Â  Â  showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  btn.innerHTML = '<div class="spinner"></div>';
Â  Â  btn.disabled = true;
Â  Â  logToConsole("Starting Upload...", "normal");

Â  Â  fetch(API_URL, {
Â  Â  Â  method: "POST",
Â  Â  Â  body: JSON.stringify(currentUpload)
Â  Â  })
Â  Â  .then(response => response.json())
Â  Â  .then(data => {
Â  Â  Â  Â // --- PRINT SERVER LOGS ---
Â  Â  Â  Â if (data.logs && data.logs.length > 0) {
Â  Â  Â  Â  Â data.logs.forEach(log => logToConsole(log));
Â  Â  Â  Â }

Â  Â  Â  Â if (data.status === "error") {
Â  Â  Â  Â  Â showToast(data.message, "error");
Â  Â  Â  Â  Â logToConsole("ERROR: " + data.message, "error");
Â  Â  Â  Â  Â btn.innerHTML = 'Ø±ÙØ¹ Ø§Ù„Ø¢Ù†';
Â  Â  Â  Â  Â btn.disabled = false;
Â  Â  Â  Â  Â return;
Â  Â  Â  Â }

Â  Â  Â  Â showToast("ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!", "success");
Â  Â  Â  Â logToConsole("Upload Success!", "success");
Â  Â  Â  Â closeModal();
Â  Â  Â  Â btn.innerHTML = 'Ø±ÙØ¹ Ø§Ù„Ø¢Ù†';
Â  Â  Â  Â btn.disabled = false;
Â  Â  Â  Â 
Â  Â  Â  Â // Smooth Remove Animation
Â  Â  Â  Â const row = document.getElementById(`row-${currentUpload.id}`);
Â  Â  Â  Â if(row) {
Â  Â  Â  Â  Â row.style.transition = 'all 0.5s ease';
Â  Â  Â  Â  Â row.style.transform = 'translateX(-20px)';
Â  Â  Â  Â  Â row.style.opacity = '0';
Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â const tbody = row.parentElement;
Â  Â  Â  Â  Â  Â row.remove();
Â  Â  Â  Â  Â  Â // Check if group is empty
Â  Â  Â  Â  Â  Â if (tbody.children.length === 0) {
Â  Â  Â  Â  Â  Â  Â  const details = tbody.closest('details');Â 
Â  Â  Â  Â  Â  Â  Â  const card = details.parentElement;Â Â 
Â  Â  Â  Â  Â  Â  Â  details.style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  details.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (card.querySelectorAll('details').length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="padding:60px; text-align:center; color:var(--text-muted);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:40px; margin-bottom:10px;">ğŸ‰</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:600;">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…!</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }, 500);
Â  Â  Â  Â }
Â  Â  })
Â  Â  .catch(err => {
Â  Â  Â  console.error(err);
Â  Â  Â  logToConsole("FETCH ERROR: " + err.toString(), "error");
Â  Â  Â  showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
Â  Â  Â  btn.innerHTML = 'Ø±ÙØ¹ Ø§Ù„Ø¢Ù†';
Â  Â  Â  btn.disabled = false;
Â  Â  });
Â  };

Â  window.switchTab = function(id) {
Â  Â  document.querySelectorAll('.subject-content').forEach(c => {
Â  Â  Â  Â  c.classList.remove('active-content');
Â  Â  Â  Â  c.style.animation = 'none';
Â  Â  Â  Â  c.offsetHeight; /* trigger reflow */
Â  Â  Â  Â  c.style.animation = null;Â 
Â  Â  });
Â  Â  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
Â  Â Â 
Â  Â  document.getElementById(id).classList.add('active-content');
Â  Â  // Find the button that was clicked based on text or onclick attribute matches if needed,Â 
Â  Â  // but simpler to just use event target if available
    if(event && event.target) event.target.classList.add('active');
  };

  // --- SEARCH / FILTER ---

  window.filterLectures = function(subject, query) {
    const container = document.getElementById(subject);
    if (!container) return;

    const rows = container.querySelectorAll('tbody tr');
    const q = (query || '').toLowerCase().trim();

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = !q || text.includes(q) ? '' : 'none';
    });
  };

  // --- THEME TOGGLING ---

  function updateThemeToggleLabel(isDark) {
    const btn = document.getElementById('themeToggle');
    if (!btn) return;
    btn.textContent = isDark ? 'â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ' : 'ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
  }

  function initTheme() {
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const useDark = saved ? saved === 'dark' : prefersDark;

    if (useDark) {
      document.body.classList.add('dark-mode');
    }

    updateThemeToggleLabel(useDark);
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/57687730-fad6-406e-985b-ff8325d62eeb', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: 'log_theme_' + Date.now(),
        timestamp: Date.now(),
        runId: 'initial',
        hypothesisId: 'H-theme',
        location: 'index.html:initTheme',
        message: 'Theme initialized',
        data: {
          saved,
          prefersDark,
          useDark,
          hasDarkClass: document.body.classList.contains('dark-mode')
        }
      })
    }).catch(() => {});
    // #endregion
  }

  window.toggleTheme = function() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeToggleLabel(isDark);
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/57687730-fad6-406e-985b-ff8325d62eeb', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: 'log_theme_toggle_' + Date.now(),
        timestamp: Date.now(),
        runId: 'initial',
        hypothesisId: 'H-theme-toggle',
        location: 'index.html:toggleTheme',
        message: 'Theme toggled',
        data: {
          isDarkAfterToggle: isDark,
          bodyClassList: Array.from(document.body.classList)
        }
      })
    }).catch(() => {});
    // #endregion
  };
</script>
</body>
</html>
